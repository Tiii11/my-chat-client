<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- Socket.IO Client: Adjust src for CDN or local -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* PASTE YOUR FULL CSS (from the version that included Phase 3&4 styles) HERE */
         @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap');
        :root { /* ... (all your CSS variables) ... */ 
            --font-primary: 'Roboto', sans-serif; --font-display: 'Orbitron', sans-serif;
            --transition-speed: 0.3s; --transition-smooth: ease-in-out; --blur-amount: 8px;
            --bg-color-light: #f0f4f8; --text-color-light: #1c1e21; --primary-accent-light: #007bff; --secondary-accent-light: #0056b3; --ui-bg-light: rgba(255, 255, 255, 0.8); --ui-bg-opaque-light: #ffffff; --ui-border-light: rgba(0, 0, 0, 0.1); --msg-sent-bg-light: linear-gradient(135deg, #007bff, #0056b3); --msg-sent-text-light: #ffffff; --msg-received-bg-light: #e9ecef; --msg-received-text-light: #1c1e21; --shadow-light: 0 6px 20px rgba(0, 0, 0, 0.08); --input-bg-light: rgba(255, 255, 255, 0.9); --placeholder-color-light: #6c757d;
            --bg-color-dark: #0a0c10; --text-color-dark: #e1e3e6; --primary-accent-dark: #6aafff; --secondary-accent-dark: #388bfd; --ui-bg-dark: rgba(22, 27, 34, 0.8); --ui-bg-opaque-dark: #161b22; --ui-border-dark: rgba(255, 255, 255, 0.15); --msg-sent-bg-dark: linear-gradient(135deg, #238636, #1a6328); --msg-sent-text-dark: #ffffff; --msg-received-bg-dark: #1c2128; --msg-received-text-dark: #e1e3e6; --shadow-dark: 0 6px 25px rgba(74, 158, 255, 0.15); --input-bg-dark: rgba(13, 17, 23, 0.9); --placeholder-color-dark: #7d8590;
            --bg-color: var(--bg-color-light); --text-color: var(--text-color-light); --primary-accent: var(--primary-accent-light); --secondary-accent: var(--secondary-accent-light); --ui-bg: var(--ui-bg-light); --ui-bg-opaque: var(--ui-bg-opaque-light); --ui-border: var(--ui-border-light); --msg-sent-bg: var(--msg-sent-bg-light); --msg-sent-text: var(--msg-sent-text-light); --msg-received-bg: var(--msg-received-bg-light); --msg-received-text: var(--msg-received-text-light); --shadow: var(--shadow-light); --input-bg: var(--input-bg-light); --placeholder-color: var(--placeholder-color-light);
        }
        body.dark-mode { /* ... (dark mode variables) ... */ 
            --bg-color: var(--bg-color-dark); --text-color: var(--text-color-dark); --primary-accent: var(--primary-accent-dark); --secondary-accent: var(--secondary-accent-dark); --ui-bg: var(--ui-bg-dark); --ui-bg-opaque: var(--ui-bg-opaque-dark); --ui-border: var(--ui-border-dark); --msg-sent-bg: var(--msg-sent-bg-dark); --msg-sent-text: var(--msg-sent-text-dark); --msg-received-bg: var(--msg-received-bg-dark); --msg-received-text: var(--msg-received-text-dark); --shadow: var(--shadow-dark); --input-bg: var(--input-bg-dark); --placeholder-color: var(--placeholder-color-dark);
        }
        /* ... (Rest of your full CSS from before) ... */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-primary); background-color: var(--bg-color); background: linear-gradient(135deg, var(--bg-color), var(--secondary-accent)); color: var(--text-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; transition: background var(--transition-speed) var(--transition-smooth), color var(--transition-speed) var(--transition-smooth); }
        .app-container { width: 95vw; max-width: 800px; height: 90vh; max-height: 750px; background-color: var(--ui-bg); backdrop-filter: blur(var(--blur-amount)); border-radius: 24px; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--ui-border); transition: background-color var(--transition-speed) var(--transition-smooth), border-color var(--transition-speed) var(--transition-smooth); }
        .chat-header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--ui-border); flex-shrink: 0; background-color: transparent; transition: border-color var(--transition-speed) var(--transition-smooth); position: relative; }
        .chat-header h1 { font-family: var(--font-display); font-size: 1.4em; color: var(--primary-accent); transition: color var(--transition-speed) var(--transition-smooth); letter-spacing: 1px; }
        .chat-header .connection-status { font-size: 0.7em; padding: 3px 8px; border-radius: 5px; margin-left: auto; margin-right: 15px; text-transform: uppercase; font-weight: bold;}
        .chat-header .connection-status.connected { background-color: #28a745; color: white; }
        .chat-header .connection-status.disconnected { background-color: #dc3545; color: white; }
        .chat-header .connection-status.error { background-color: #ffc107; color: black; }
        .theme-switcher { display: flex; align-items: center; cursor: pointer; flex-shrink: 0; margin-left: 10px; }
        .switch-track { width: 50px; height: 26px; background-color: var(--ui-border); border-radius: 13px; position: relative; transition: background-color var(--transition-speed) var(--transition-smooth); }
        .switch-thumb { width: 20px; height: 20px; background-color: var(--ui-bg-opaque); border-radius: 50%; position: absolute; top: 3px; left: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        body.dark-mode .switch-thumb { background-color: var(--text-color-dark); }
        #logoutButton { background: none; border: 1px solid var(--ui-border); color: var(--text-color); padding: 4px 10px; border-radius: 5px; cursor: pointer; margin-left: 15px; font-size: 0.8em; transition: all 0.2s ease; display: none; }
        #logoutButton:hover { background-color: var(--ui-border); border-color: var(--text-color);}
        body.dark-mode #logoutButton { border-color: var(--ui-border-dark); }
        body.dark-mode #logoutButton:hover { background-color: var(--ui-border-dark); border-color: var(--text-color-dark);}
        #authContainer { display: flex; flex-direction: column; align-items: center; padding: 30px; flex-grow: 1; justify-content: center; background-color: var(--ui-bg-opaque); transition: background-color var(--transition-speed) var(--transition-smooth); }
        #loginForm, #registerForm { display: flex; flex-direction: column; gap: 15px; width: 90%; max-width: 350px; padding: 20px; border-radius: 10px; background-color: var(--ui-bg-opaque); border: 1px solid var(--ui-border); box-shadow: var(--shadow-light); }
         body.dark-mode #loginForm, body.dark-mode #registerForm { box-shadow: var(--shadow-dark); }
        #registerForm { display: none; } 
         #authContainer h2 { text-align: center; margin-bottom: 10px; color: var(--primary-accent); font-family: var(--font-display); }
         #authContainer input[type="text"], #authContainer input[type="password"] { padding: 12px; border-radius: 8px; border: 1px solid var(--ui-border); background-color: var(--input-bg); color: var(--text-color); font-size: 0.95em; }
         #authContainer button { padding: 12px; border-radius: 8px; background: var(--primary-accent); color: white; border: none; cursor: pointer; font-weight: bold; font-size: 1em; transition: background-color 0.2s ease; }
         #authContainer button:hover { background: var(--secondary-accent); }
         #authContainer .error-message { color: #e53e3e; font-size: 0.85em; text-align: center; min-height: 1.2em; }
         #authContainer p { text-align: center; font-size: 0.9em; }
         #authContainer a { color: var(--primary-accent); text-decoration: none; cursor: pointer; }
         #authContainer a:hover { text-decoration: underline; }
        .chat-main { display: flex; flex-grow: 1; overflow: hidden; border-top: 1px solid var(--ui-border); }
        .sidebar { width: 180px; border-right: 1px solid var(--ui-border); display: flex; flex-direction: column; background-color: transparent; padding-top: 15px; padding-bottom: 15px; overflow-y: auto; flex-shrink: 0; transition: background-color var(--transition-speed) var(--transition-smooth), border-color var(--transition-speed) var(--transition-smooth); }
        .sidebar h2 { font-size: 0.75em; padding: 8px 15px 4px 15px; margin-top: 10px; color: var(--secondary-accent); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; }
        .sidebar h2:first-of-type { margin-top: 0; }
        .user-list, .conversation-list { list-style: none; padding: 0; margin: 0 0 15px 0; }
        .user-list li, .conversation-list li { padding: 10px 15px; font-size: 0.9em; cursor: pointer; border-bottom: 1px solid var(--ui-border); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background-color 0.2s var(--transition-smooth), color 0.2s var(--transition-smooth); position: relative; }
        .user-list li:hover, .conversation-list li:hover { background-color: rgba(0,0,0,0.04); }
        body.dark-mode .user-list li:hover, body.dark-mode .conversation-list li:hover { background-color: rgba(255,255,255,0.04); }
        .user-list li.is-me { font-style: italic; color: var(--primary-accent); cursor: default; }
        .conversation-list li.active { background-color: var(--primary-accent); color: white; font-weight: bold; }
        body.dark-mode .conversation-list li.active { color: var(--ui-bg-opaque-dark); }
        .conversation-list li .unread-indicator { background-color: #dc3545; width: 8px; height: 8px; border-radius: 50%; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: none; }
        .conversation-list li.has-unread .unread-indicator { display: block; }
        .chat-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background-color: transparent;}
        .messages-container { display: none; flex-grow: 1; padding: 25px; overflow-y: auto; flex-direction: column; gap: 18px; scrollbar-width: thin; scrollbar-color: var(--primary-accent) transparent; scroll-behavior: smooth; }
        .messages-container::-webkit-scrollbar { width: 6px; }
        .messages-container::-webkit-scrollbar-track { background: transparent; }
        .messages-container::-webkit-scrollbar-thumb { background-color: var(--primary-accent); border-radius: 3px; }
        .messages-container.active-chat { display: flex; }
        .message, .system-message { display: flex; max-width: 85%; }
        .system-message { align-self: center; max-width: 100%; font-style: italic; font-size: 0.85em; color: var(--text-color); opacity: 0.6; padding: 8px 0; text-align: center;}
        .message-bubble { padding: 12px 18px; border-radius: 20px; line-height: 1.5; font-size: 0.95em; word-wrap: break-word; box-shadow: 0 3px 8px rgba(0,0,0,0.06); transition: background var(--transition-speed) var(--transition-smooth), color var(--transition-speed) var(--transition-smooth); }
        .message-text { margin-bottom: 5px; }
        .message-meta { font-size: 0.7em; opacity: 0.7; text-align: right; margin-top: 3px;}
        .message.sent { align-self: flex-end; }
        .message.sent .message-bubble { background: var(--msg-sent-bg); color: var(--msg-sent-text); border-bottom-right-radius: 6px; }
        .message.received { align-self: flex-start; }
        .message.received .message-bubble { background-color: var(--msg-received-bg); color: var(--msg-received-text); border-bottom-left-radius: 6px; }
        .message-bubble.pm-sent { background: var(--secondary-accent-light); border: 1px solid var(--primary-accent-light); color: var(--msg-sent-text-light); }
        .message-bubble.pm-received { background-color: var(--ui-border-light); border: 1px solid var(--text-color-light); color: var(--msg-received-text-light); }
        body.dark-mode .message-bubble.pm-sent { background: var(--secondary-accent-dark); border: 1px dashed var(--primary-accent-dark); color: var(--msg-sent-text-dark); }
        body.dark-mode .message-bubble.pm-received { background-color: var(--ui-border-dark); border: 1px dashed var(--text-color-dark); color: var(--msg-received-text-dark); }
        .message-input-area { display: flex; padding: 15px 20px; border-top: 1px solid var(--ui-border); background-color: var(--ui-bg); backdrop-filter: blur(var(--blur-amount)); transition: border-color var(--transition-speed) var(--transition-smooth), background-color var(--transition-speed) var(--transition-smooth); flex-shrink: 0; gap: 10px; }
        .message-input-area textarea { flex-grow: 1; padding: 12px 18px; border: 1px solid var(--ui-border); border-radius: 22px; resize: none; font-family: var(--font-primary); font-size: 0.95em; background-color: var(--input-bg); color: var(--text-color); transition: all var(--transition-speed) var(--transition-smooth); min-height: 46px; max-height: 100px; overflow-y: auto; }
        .message-input-area textarea::placeholder { color: var(--placeholder-color); transition: color var(--transition-speed) var(--transition-smooth); }
        .message-input-area textarea:focus { outline: none; border-color: var(--primary-accent); box-shadow: 0 0 0 3px var(--primary-accent-dark_alpha, rgba(74, 158, 255, 0.3)); }
        body.dark-mode .message-input-area textarea:focus { box-shadow: 0 0 0 3px var(--primary-accent-light_alpha, rgba(0, 123, 255, 0.3)); }
        .message-input-area button { padding: 0 20px; background: var(--primary-accent); color: white; border: none; border-radius: 22px; cursor: pointer; font-family: var(--font-primary); font-weight: bold; font-size: 0.95em; transition: background-color var(--transition-speed) var(--transition-smooth), transform 0.1s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; height: 46px; }
        .message-input-area button:hover { background: var(--secondary-accent); }
        .message-input-area button:active { transform: scale(0.97); }
        .message-input-area button svg { width: 18px; height: 18px; fill: white; }

    </style>
</head>
<body>
    <div class="app-container">
        <div class="chat-header">
            <h1 id="windowTitle">Nexus Chat</h1>
            <span id="connectionStatus" class="connection-status disconnected">Offline</span>
            <button id="logoutButton" style="display: none;">Logout</button>
            <div class="theme-switcher" id="themeSwitcher">
                <div class="switch-track"><div class="switch-thumb" id="switchThumb"></div></div>
            </div>
        </div>

         <div id="authContainer">
            <form id="loginForm"><h2>Login</h2><input type="text" id="loginUsername" placeholder="Username" required><input type="password" id="loginPassword" placeholder="Password" required><button type="submit">Login</button><p id="loginError" class="error-message"></p><p>Don't have an account? <a href="#" id="showRegisterLink">Register</a></p></form>
            <form id="registerForm" style="display: none;"><h2>Register</h2><input type="text" id="registerUsername" placeholder="Username (3-15 chars, A-Z, 0-9, _)" required><input type="password" id="registerPassword" placeholder="Password (min 6 chars)" required><input type="password" id="registerConfirmPassword" placeholder="Confirm Password" required><button type="submit">Register</button><p id="registerError" class="error-message"></p><p>Already have an account? <a href="#" id="showLoginLink">Login</a></p></form>
         </div>

        <div class="chat-main" id="chatMainArea" style="display: none;">
            <div class="sidebar" id="sidebar">
                <h2>Online Users</h2> <ul class="user-list" id="userList"></ul>
                <h2>Conversations</h2> <ul class="conversation-list" id="conversationList"><li class="active" data-conversation-id="global">Global Chat</li></ul>
            </div>
            <div class="chat-content" id="chatContent">
                <div class="messages-container active-chat" id="messagesContainer_global">
                    <p class="system-message loading-history" data-conversation-id="global_chat_loading" style="display:none;">Loading history...</p>
                </div>
            </div>
        </div>

        <div class="message-input-area" id="chatInputArea" style="display: none;">
            <textarea id="messageInput" placeholder="Type message..." rows="1"></textarea>
            <button id="sendMessageBtn"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button>
        </div>
    </div> 

    <script>
        // --- DOM Elements ---
        const themeSwitcher = document.getElementById('themeSwitcher'); const switchThumb = document.getElementById('switchThumb'); const windowTitle = document.getElementById('windowTitle'); const connectionStatusEl = document.getElementById('connectionStatus'); const logoutButton = document.getElementById('logoutButton'); const authContainer = document.getElementById('authContainer'); const loginForm = document.getElementById('loginForm'); const registerForm = document.getElementById('registerForm'); const loginUsernameInput = document.getElementById('loginUsername'); const loginPasswordInput = document.getElementById('loginPassword'); const loginErrorDisplay = document.getElementById('loginError'); const registerUsernameInput = document.getElementById('registerUsername'); const registerPasswordInput = document.getElementById('registerPassword'); const registerConfirmPasswordInput = document.getElementById('registerConfirmPassword'); const registerErrorDisplay = document.getElementById('registerError'); const showRegisterLink = document.getElementById('showRegisterLink'); const showLoginLink = document.getElementById('showLoginLink'); const chatMainArea = document.getElementById('chatMainArea'); const sidebar = document.getElementById('sidebar'); const userList = document.getElementById('userList'); const conversationList = document.getElementById('conversationList'); const chatContent = document.getElementById('chatContent'); const chatInputArea = document.getElementById('chatInputArea'); const messageInput = document.getElementById('messageInput'); const sendMessageBtn = document.getElementById('sendMessageBtn'); const globalMessagesContainer = document.getElementById('messagesContainer_global'); // Specific ref

        // --- App State ---
        const ACTIVE_SERVER_URL = 'https://chat-server-kbrx.onrender.com';
        let socket = null; let myUsername = localStorage.getItem('username') || null; let authToken = localStorage.getItem('token') || null;
        let activeConversationId = 'global';
        const pmMessageContainers = {}; const loadedHistories = new Set(); 

        // --- Theme Logic ---
        let currentTheme = localStorage.getItem('app-theme') || 'light';
        function applyTheme(theme) { /* ... */ } if (themeSwitcher) { /* ... */ }
        function applyTheme(theme) { document.body.classList.toggle('dark-mode', theme === 'dark'); if (typeof anime === 'function') { anime({ targets: switchThumb, translateX: theme === 'dark' ? 24 : 0, duration: 400, easing: 'easeOutQuint' }); } }
        if (themeSwitcher) { themeSwitcher.addEventListener('click', () => { currentTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark'; localStorage.setItem('app-theme', currentTheme); applyTheme(currentTheme); }); }

        // --- UI State Functions ---
        function showAuthView(view = 'login') { /* ... */ } function showChatView() { /* ... */ }
        function showAuthView(view = 'login') { if (!authContainer || !chatMainArea || !chatInputArea) return; console.log(`DEBUG: Showing ${view} view`); authContainer.style.display = 'flex'; chatMainArea.style.display = 'none'; chatInputArea.style.display = 'none'; if (loginForm) loginForm.style.display = (view === 'login') ? 'flex' : 'none'; if (registerForm) registerForm.style.display = (view === 'register') ? 'flex' : 'none'; if (view === 'login' && loginUsernameInput) loginUsernameInput.focus(); if (view === 'register' && registerUsernameInput) registerUsernameInput.focus(); if (connectionStatusEl) connectionStatusEl.textContent = 'Login Required'; if (connectionStatusEl) connectionStatusEl.classList.remove('connected', 'error'); if (connectionStatusEl) connectionStatusEl.classList.add('disconnected'); if (logoutButton) logoutButton.style.display = 'none'; }
        function showChatView() { if (!authContainer || !chatMainArea || !chatInputArea) return; console.log("DEBUG: showChatView (authenticated)"); authContainer.style.display = 'none'; chatMainArea.style.display = 'flex'; chatInputArea.style.display = 'flex'; if (messageInput) messageInput.focus(); if (logoutButton) logoutButton.style.display = 'inline-block'; }

        // --- API Call Functions ---
        async function handleLogin(event) { /* ... Same as previous with FIXED fetch URL ... */ }
        async function handleRegister(event) { /* ... Same as previous with FIXED fetch URL ... */ }
        function handleLogout() { /* ... Same as previous ... */ }
        async function handleLogin(event) { event.preventDefault(); const username = loginUsernameInput.value; const password = loginPasswordInput.value; if (loginErrorDisplay) loginErrorDisplay.textContent = ''; try { const apiUrl = `${ACTIVE_SERVER_URL}/api/auth/login`; console.log("DEBUG: Attempting login to:", apiUrl); const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); if (!response.ok) { let errorMsg = `Login failed (${response.status})`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (jsonError) {} throw new Error(errorMsg); } const data = await response.json(); console.log('DEBUG: Login successful', data); authToken = data.token; myUsername = data.user.username; localStorage.setItem('token', authToken); localStorage.setItem('username', myUsername); if (windowTitle && myUsername) windowTitle.textContent = `Nexus Chat (${myUsername})`; showChatView(); connectToServer(); } catch (error) { console.error('DEBUG: Login failed:', error); if (loginErrorDisplay) loginErrorDisplay.textContent = error.message || 'Login failed.'; } }
        async function handleRegister(event) { event.preventDefault(); const username = registerUsernameInput.value; const password = registerPasswordInput.value; const confirmPassword = registerConfirmPasswordInput.value; if (registerErrorDisplay) registerErrorDisplay.textContent = ''; if (password !== confirmPassword) { if(registerErrorDisplay) registerErrorDisplay.textContent = 'Passwords do not match.'; return; } if (password.length < 6) { if(registerErrorDisplay) registerErrorDisplay.textContent = 'Password min 6 characters.'; return; } if (!/^[a-zA-Z0-9_]+$/.test(username) || username.length < 3 || username.length > 15) { if(registerErrorDisplay) registerErrorDisplay.textContent = 'Username invalid (3-15 chars, A-Z, 0-9, _).'; return; } try { const apiUrl = `${ACTIVE_SERVER_URL}/api/auth/register`; console.log("DEBUG: Attempting registration to:", apiUrl); const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); if (!response.ok) { let errorMsg = `Registration failed (${response.status})`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch (jsonError) {} throw new Error(errorMsg); } const data = await response.json(); console.log('DEBUG: Registration successful', data); alert('Registration successful! Please login.'); showAuthView('login'); } catch (error) { console.error('DEBUG: Registration failed:', error); if (registerErrorDisplay) registerErrorDisplay.textContent = error.message || 'Registration failed.'; } }
        function handleLogout() { console.log("DEBUG: Logging out"); localStorage.removeItem('token'); localStorage.removeItem('username'); authToken = null; myUsername = null; if (socket && socket.connected) { socket.disconnect(); } socket = null; if (windowTitle) windowTitle.textContent = 'Nexus Chat'; showAuthView('login'); if(globalMessagesContainer) globalMessagesContainer.innerHTML = ''; document.querySelectorAll('.chat-content .messages-container:not(#messagesContainer_global)').forEach(div => div.remove()); if(userList) userList.innerHTML = ''; document.querySelectorAll('#conversationList li:not([data-conversation-id="global"])').forEach(li => li.remove()); Object.keys(pmMessageContainers).forEach(key => delete pmMessageContainers[key]); activeConversationId = 'global'; loadedHistories.clear(); if (conversationList) { document.querySelectorAll('#conversationList li').forEach(li => { li.classList.toggle('active', li.dataset.conversationId === 'global'); li.classList.remove('has-unread'); }); } }

        // --- Socket.IO Connection (Modified for History) ---
        function connectToServer() { /* ... same ... */ }
        function handleGlobalMessage(messageData) { /* ... same ... */ }
        function handlePrivateMessage(messageData) { /* ... same ... */ }
        function handlePrivateMessageFailure(errorData) { /* ... same ... */ }
        function updateUserList(usernames) { /* ... same ... */ }
        function handleDisconnect(reason) { /* ... same ... */ }
        function handleConnectError(err) { /* ... same ... */ }
        function connectToServer() {
            if (socket && socket.connected) { console.log("DEBUG: Socket already connected."); return; }
            if (!authToken) { console.log("DEBUG: No auth token, cannot connect socket."); showAuthView('login'); return; }
            console.log(`DEBUG: Attempting to connect socket with auth token...`);
            if(connectionStatusEl) connectionStatusEl.textContent = 'Connecting...';
            if (socket) { socket.disconnect(); } 
            socket = io(ACTIVE_SERVER_URL, { transports: ['websocket', 'polling'], reconnectionAttempts: 5, auth: { token: authToken } });
            socket.on('connect', () => { console.log('DEBUG: Socket connected and authenticated. ID:', socket.id); if(connectionStatusEl) { connectionStatusEl.textContent = 'Online'; connectionStatusEl.classList.add('connected'); connectionStatusEl.classList.remove('disconnected', 'error'); } addSystemMessage('Connected to chat.', 'global'); showChatView(); socket.emit('request_user_list'); requestMessageHistory('global'); }); /* Request global history */
            socket.on('load_history', ({ conversationId, messages, error }) => { console.log(`DEBUG: Received 'load_history' for ${conversationId}`, messages); const loadingIndicator = document.querySelector(`.loading-history[data-conversation-id="${conversationId}_loading"]`); if (loadingIndicator) loadingIndicator.style.display = 'none'; if (error) { addSystemMessage(`Error loading history for ${conversationId}: ${error}`, conversationId === 'global' ? 'global' : conversationId); return; } const targetContainerId = conversationId === 'global' ? 'messagesContainer_global' : `messagesContainer_${conversationId}`; const targetContainer = document.getElementById(targetContainerId); if (targetContainer) { if (!loadedHistories.has(conversationId)) { targetContainer.innerHTML = ''; if (conversationId.startsWith('pm_')) { const otherUser = conversationId.replace('pm_', ''); const pmHeader = document.createElement('p'); pmHeader.classList.add('system-message'); pmHeader.textContent = `Private Chat with ${otherUser}`; pmHeader.style.fontWeight = 'bold'; targetContainer.appendChild(pmHeader); } } messages.forEach(msg => { displayChatMessage(msg.text, msg.senderUsername, msg.timestamp, msg.socketId, conversationId !== 'global', msg.recipient ? (msg.senderUsername === myUsername ? 'sent' : 'received') : null, msg.recipient ? (msg.senderUsername === myUsername ? (onlineUsers[msg.recipient.toString()] ? onlineUsers[msg.recipient.toString()].username : 'User') : msg.senderUsername) : null ); }); targetContainer.scrollTop = targetContainer.scrollHeight; loadedHistories.add(conversationId); } else { console.warn(`DEBUG: Target container not found for history: ${targetContainerId}`); } });
            socket.on('connect_error', (err) => { console.error(`DEBUG: Socket Connection/Auth Error:`, err.message); if (err.message.toLowerCase().includes('authentication error')) { addSystemMessage(`Authentication failed: ${err.message}. Logging out.`, 'global'); handleLogout(); } else { addSystemMessage(`Connection Error: ${err.message}. Retrying...`, 'global'); if(connectionStatusEl) { connectionStatusEl.textContent = 'Error'; connectionStatusEl.classList.add('error'); connectionStatusEl.classList.remove('connected', 'disconnected'); } } });
            socket.on('disconnect', (reason) => { console.log(`DEBUG: Socket disconnected. Reason: ${reason}`); addSystemMessage(`Disconnected: ${reason}. Reconnecting...`, 'global'); if(connectionStatusEl) { connectionStatusEl.textContent = 'Offline'; connectionStatusEl.classList.add('disconnected'); connectionStatusEl.classList.remove('connected', 'error'); } loadedHistories.clear(); });
            socket.on('receive_message', handleGlobalMessage); socket.on('receive_private_message', handlePrivateMessage); socket.on('private_message_failed', handlePrivateMessageFailure); socket.on('update_user_list', updateUserList); socket.on('user_connected', (username) => { if (username !== myUsername) addSystemMessage(`${username} has joined.`, 'global'); }); socket.on('user_disconnected', (username) => { if (username !== myUsername) addSystemMessage(`${username} has left.`, 'global'); }); socket.on('general_error', (errorMessage) => { addSystemMessage(`Server Error: ${errorMessage}`, 'global'); });
        }
        function handleGlobalMessage(messageData) { console.log("DEBUG: Received global message:", messageData); if (!socket || !messageData.socketId || (messageData.socketId !== socket.id)) { displayChatMessage(messageData.text, messageData.senderUsername, messageData.timestamp, messageData.socketId, false, null, 'global'); } }
        function handlePrivateMessage(messageData) { console.log("DEBUG: Received private message data:", messageData); let participant = ""; let isOwn = false; if (messageData.type === 'sent') { participant = messageData.recipientUsername; isOwn = true; } else if (messageData.type === 'received') { participant = messageData.senderUsername; isOwn = false; } else { return; } const conversationId = openOrCreatePMConversation(participant, false); displayChatMessage(messageData.text, isOwn ? myUsername : participant, messageData.timestamp, isOwn ? socket.id : null, true, messageData.type, participant); if (!isOwn && conversationId !== activeConversationId) { const conversationTab = document.querySelector(`#conversationList li[data-conversation-id="${conversationId}"]`); if (conversationTab) { conversationTab.classList.add('has-unread'); } } }
        function handlePrivateMessageFailure(errorData) { console.log("DEBUG: Private message failed:", errorData); const message = `Failed to send PM to "${errorData.recipientUsername}". Reason: ${errorData.reason}`; addSystemMessage(message, 'global'); }
        function updateUserList(usernames) { console.log("DEBUG: Received user list update:", usernames); if (!userList) return; const onlineUsersList = usernames.filter(u => u !== null && u !== undefined); userList.innerHTML = ''; onlineUsersList.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())); onlineUsersList.forEach(username => { const li = document.createElement('li'); li.textContent = username; li.dataset.username = username; if (username === myUsername) { li.classList.add('is-me'); li.textContent += " (You)"; } else { li.addEventListener('click', () => openOrCreatePMConversation(username, true)); } userList.appendChild(li); }); }

        // --- UI Interaction Functions ---
        function openOrCreatePMConversation(username, switchToConversation = true) { /* ... same ... */ }
        function switchConversation(conversationId) { /* ... modified to request history ... */ }
        function displayChatMessage(text, senderUsername, timestampISO, messageSocketId, isPM = false, pmType = null, otherParty = null) { /* ... same with timestamp formatting ... */ }
        function appendMessageToContainer(containerElement, text, senderUsername, formattedTimestamp, messageSocketId, isPM, pmType, otherParty) { /* ... same ... */ }
        function addSystemMessage(text, targetId = null) { /* ... same ... */ }
        function handleSendMessageToServer() { /* ... same ... */ }
        function openOrCreatePMConversation(username, switchToConversation = true) { if (!username || username === myUsername) return null; console.log(`DEBUG: Opening/creating PM with ${username}. Switch: ${switchToConversation}`); const conversationId = `pm_${username}`; let conversationTab = document.querySelector(`#conversationList li[data-conversation-id="${conversationId}"]`); if (!conversationTab && conversationList) { conversationTab = document.createElement('li'); conversationTab.textContent = username; conversationTab.dataset.conversationId = conversationId; const unreadIndicator = document.createElement('span'); unreadIndicator.classList.add('unread-indicator'); conversationTab.appendChild(unreadIndicator); conversationTab.addEventListener('click', () => switchConversation(conversationId)); conversationList.appendChild(conversationTab); } if (!pmMessageContainers[username] && chatContent) { const pmContainer = document.createElement('div'); pmContainer.id = `messagesContainer_${conversationId}`; pmContainer.classList.add('messages-container'); const pmHeader = document.createElement('p'); pmHeader.classList.add('system-message'); pmHeader.textContent = `Private Chat with ${username}`; pmHeader.style.fontWeight = 'bold'; pmContainer.appendChild(pmHeader); const loadingIndicator = document.createElement('p'); loadingIndicator.classList.add('system-message', 'loading-history'); loadingIndicator.textContent = 'Loading history...'; loadingIndicator.dataset.conversationId = `${conversationId}_loading`; pmContainer.appendChild(loadingIndicator); chatContent.appendChild(pmContainer); pmMessageContainers[username] = pmContainer; } if (switchToConversation) { switchConversation(conversationId); } return conversationId; }
        function switchConversation(conversationId) { console.log(`DEBUG: Switching conversation to ${conversationId}`); if (activeConversationId === conversationId && document.querySelector(`#messagesContainer_${conversationId}.active-chat`)) return; activeConversationId = conversationId; document.querySelectorAll('#conversationList li').forEach(li => { const isActive = li.dataset.conversationId === conversationId; li.classList.toggle('active', isActive); if (isActive) { li.classList.remove('has-unread'); } }); document.querySelectorAll('.chat-content .messages-container').forEach(container => { const isActive = container.id === `messagesContainer_${conversationId}`; container.classList.toggle('active-chat', isActive); if (isActive) { container.scrollTop = container.scrollHeight; } }); const historyIdToRequest = conversationId === 'global' ? 'global_chat' : conversationId; const recipientUsernameForPMHistory = conversationId.startsWith('pm_') ? conversationId.replace('pm_', '') : null; if (socket && socket.connected && !loadedHistories.has(historyIdToRequest)) { console.log(`DEBUG: Requesting history for ${historyIdToRequest}`); const loadingIndicator = document.querySelector(`.loading-history[data-conversation-id="${historyIdToRequest}_loading"]`); if (loadingIndicator) loadingIndicator.style.display = 'block'; socket.emit('request_history', { conversationId: historyIdToRequest, recipientUsername: recipientUsernameForPMHistory }); } if (!messageInput) return; if (conversationId === 'global') { messageInput.placeholder = "Type message or /msg user message"; } else { const targetUser = conversationId.replace('pm_', ''); messageInput.placeholder = `Private message to ${targetUser}...`; } messageInput.focus(); }
        function displayChatMessage(text, senderUsername, timestampISO, messageSocketId, isPM = false, pmType = null, otherParty = null) { const targetConversationId = isPM ? `pm_${(pmType === 'sent' ? otherParty : senderUsername)}` : 'global'; let targetContainer = document.getElementById(`messagesContainer_${targetConversationId}`); let formattedTime = ''; try { const date = new Date(timestampISO); if (!isNaN(date.getTime())) { formattedTime = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }); } else { formattedTime = "??:??"; } } catch (e) { console.error("Error formatting date:", timestampISO, e); formattedTime = "??:??"; } if (!targetContainer) { if (isPM && pmType === 'received') { console.log("DEBUG: Received PM for inactive conversation, creating UI for:", senderUsername); const newConvId = openOrCreatePMConversation(senderUsername, false); targetContainer = document.getElementById(`messagesContainer_${newConvId}`); if (!targetContainer) { console.error(`DEBUG: Failed to find/create container for PM with ${senderUsername}`); return; } appendMessageToContainer(targetContainer, text, senderUsername, formattedTime, messageSocketId, isPM, pmType, otherParty); } else { console.warn(`DEBUG: messagesContainer not found for ID: messagesContainer_${targetConversationId}`); return; } } else { appendMessageToContainer(targetContainer, text, senderUsername, formattedTime, messageSocketId, isPM, pmType, otherParty); } }
        function appendMessageToContainer(containerElement, text, senderUsername, formattedTimestamp, messageSocketId, isPM, pmType, otherParty) { const isOwnMessage = (socket && messageSocketId === socket.id && myUsername); const messageClass = isOwnMessage ? 'sent' : 'received'; const messageDiv = document.createElement('div'); messageDiv.classList.add('message', messageClass); const bubbleDiv = document.createElement('div'); bubbleDiv.classList.add('message-bubble'); let metaPrefix = ""; if (isPM) { bubbleDiv.classList.add(pmType === 'sent' ? 'pm-sent' : 'pm-received'); metaPrefix = pmType === 'sent' ? `(PM to ${otherParty}) ` : `(PM from ${senderUsername}) `; } const textP = document.createElement('p'); textP.classList.add('message-text'); textP.textContent = text; const metaSpan = document.createElement('span'); metaSpan.classList.add('message-meta'); const metaUsernameDisplay = isOwnMessage ? 'You' : senderUsername; metaSpan.textContent = `${metaPrefix}${metaUsernameDisplay} • ${formattedTimestamp}`; bubbleDiv.appendChild(textP); bubbleDiv.appendChild(metaSpan); messageDiv.appendChild(bubbleDiv); containerElement.appendChild(messageDiv); if (typeof anime === 'function') { anime({ targets: messageDiv, opacity: [0, 1], translateY: [15, 0], scale: [0.95, 1], duration: 450, easing: 'easeOutExpo' }); } if ('scrollBehavior' in document.documentElement.style) { containerElement.scrollTo({ top: containerElement.scrollHeight, behavior: 'smooth' }); } else { containerElement.scrollTop = containerElement.scrollHeight; } }
        function addSystemMessage(text, targetId = null) { let targetContainer; if (targetId) { targetContainer = document.getElementById(`messagesContainer_${targetId}`); } else { targetContainer = document.querySelector('.chat-content .messages-container.active-chat'); } if (!targetContainer) targetContainer = document.getElementById('messagesContainer_global'); if (!targetContainer) { console.warn("DEBUG: messagesContainer not found for system message"); return; } const messageDiv = document.createElement('div'); messageDiv.classList.add('system-message'); messageDiv.textContent = text; targetContainer.appendChild(messageDiv); targetContainer.scrollTop = targetContainer.scrollHeight; if (typeof anime === 'function') { anime({ targets: messageDiv, opacity: [0, 1], duration: 400, easing: 'easeOutQuad' }); } }
        function handleSendMessageToServer() { if (!messageInput || !sendMessageBtn) return; const messageText = messageInput.value.trim(); if (!messageText) return; if (!socket || !socket.connected) { addSystemMessage("Cannot send: Not connected."); return; } if (!myUsername) { addSystemMessage("Cannot send: Username not set."); showAuthView('login'); return; } const pmMatch = messageText.match(/^\/msg\s+([a-zA-Z0-9_]{3,15})\s+(.+)/); if (pmMatch) { const recipientUsername = pmMatch[1]; const pmText = pmMatch[2]; if (recipientUsername.toLowerCase() === myUsername.toLowerCase()) { addSystemMessage("You cannot /msg yourself.", 'global'); return; } console.log(`DEBUG: Sending explicit PM to ${recipientUsername}: ${pmText}`); socket.emit('send_private_message', { recipientUsername: recipientUsername, text: pmText }); openOrCreatePMConversation(recipientUsername, true); } else if (activeConversationId === 'global') { console.log(`DEBUG: Sending global message: ${messageText}`); const messageData = { text: messageText }; const now = new Date(); const timestamp = now.toISOString(); displayChatMessage(messageText, myUsername, timestamp, socket.id, false, null, 'global'); socket.emit('send_message', messageData); } else if (activeConversationId.startsWith('pm_')) { const recipientUsername = activeConversationId.replace('pm_', ''); console.log(`DEBUG: Sending implicit PM to ${recipientUsername}: ${messageText}`); socket.emit('send_private_message', { recipientUsername: recipientUsername, text: messageText }); } else { console.error("DEBUG: Unknown active conversation ID:", activeConversationId); addSystemMessage("Error: Cannot determine recipient.", 'global'); } messageInput.value = ''; messageInput.style.height = 'auto'; messageInput.focus(); }


        // --- Event Listeners for UI ---
        if (loginForm) { /* ... */ } if (registerForm) { /* ... */ } if (showRegisterLink) { /* ... */ } if (showLoginLink) { /* ... */ } if (logoutButton) { /* ... */ }
        if (sendMessageBtn && messageInput) { /* ... */ } const globalChatTab = document.querySelector('#conversationList li[data-conversation-id="global"]'); if (globalChatTab) { /* ... */ }
         if (loginForm) loginForm.addEventListener('submit', handleLogin); else console.warn("Login form not found");
         if (registerForm) registerForm.addEventListener('submit', handleRegister); else console.warn("Register form not found");
         if (showRegisterLink) showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showAuthView('register'); }); else console.warn("ShowRegisterLink not found");
         if (showLoginLink) showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showAuthView('login'); }); else console.warn("ShowLoginLink not found");
         if (logoutButton) logoutButton.addEventListener('click', handleLogout); else console.warn("Logout button not found");
         if (sendMessageBtn && messageInput) { sendMessageBtn.addEventListener('click', handleSendMessageToServer); messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessageToServer(); } }); messageInput.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; }); } else { console.warn("DEBUG: messageInput or sendMessageBtn for chat not found."); }
         if (globalChatTab) { globalChatTab.addEventListener('click', () => switchConversation('global')); } else { console.warn("DEBUG: Global chat tab not found.") }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme);
            if (authToken) {
                console.log("DEBUG: Found token. Optimistically show chat, then connect.");
                myUsername = localStorage.getItem('username');
                if (windowTitle && myUsername) windowTitle.textContent = `Nexus Chat (${myUsername})`;
                showChatView(); 
                connectToServer();
            } else {
                console.log("DEBUG: No token. Show auth view.");
                showAuthView('login');
            }
        });
    </script>
</body>
</html>